<!DOCTYPE html>
<!--
    This file is part of Orzo.

    Orzo is free software: you can redistribute it and/or modify it
    under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Orzo is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Orzo. If not, see <https://www.gnu.org/licenses/>.

    Copyright 2014 Wolfgang Puffitsch
-->
<html>
  <head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Material+Icons');
      body {
        font-family: 'Roboto Mono', monospace;
        background-color: #101010;
        color: #D0D0D0;
        width: 96vw;
        max-width: 640px;
      }
    </style>
  </head>
  <body>
    <main-app></main-app>
  </body>
  <script>
const template = document.createElement('template');
template.innerHTML = `
 <style>
    div.content {
        width: 100%;
        container-type: inline-size;
    }
    table.content {
        width: 100%;
        border-collapse: collapse;
        font-size: 10.5cqw;
    }
    td.content {
        display: flex;
        align-items: baseline;
    }
    .battery {
        font-size: 6cqw;
    }
    #position {
        font-size: 6cqw;
    }
    button {
        font-family: 'Material Icons';
        font-size: inherit;
        background-color: inherit;
        color: inherit;
        border: 0px;
    }
    button:disabled {
        opacity: 50%;
    }
 </style>
 <div class="content">
    <table class="content">
        <tr>
            <td class="content">
                <button id='menu'>menu</button>
                <div style="flex: 1"></div>
                <button id='connect'>sensors</button>
                <div style="flex: 1"></div>
                <button id='startstop'>start</button>
                <div style="flex: 1"></div>
                <button id='pauseunpause' disabled>play_arrow</button>
                <div style="flex: 1"></div>
                <button id='fullscreen'>fullscreen</button>
            </td>
        </tr>
        <tr>
            <td class="content">
                HR
                <span id='hrm_bat' class="battery"></span>
                <div style="flex: 1"></div>
                <span id='hr'>n/a</span>
            </td>
        </tr>
        <tr>
            <td class="content">
                active
                <div style="flex: 1"></div>
                <span id='active'> - </span>
            </td>
        </tr>
        <tr>
            <td class="content">
                elapsed
                <div style="flex: 1"></div>
                <span id='elapsed'> - </span>
            </td>
        </tr>
        <tr>
            <td class="content">
                time
                <div style="flex: 1"></div>
                <span id='time'> - </span>
            </td>
        </tr>
        <tr>
            <td class="content">
                pos
                <div style="flex: 1"></div>
                <span id='position'> - </span>
            </td>
        </tr>
    </table>
</div>
`;

class MainApp extends HTMLElement {
    #started
    #startDate

    #active
    #activeDate
    #activeTime

    #timerID

    constructor() {
        super();

        const shadowRoot = this.attachShadow({mode: 'open'});
        shadowRoot.appendChild(template.content.cloneNode(true));

        this.doScan = this.doScan.bind(this);
        this.doStartStop = this.doStartStop.bind(this);
        this.doPauseUnpause = this.doPauseUnpause.bind(this);
        this.doFullScreen = this.doFullScreen.bind(this);
        this.onFullScreenChanged = this.onFullScreenChanged.bind(this);
        this.onTimerTick = this.onTimerTick.bind(this);
        this.onPositionChanged = this.onPositionChanged.bind(this);
        this.onHRMNotify = this.onHRMNotify.bind(this);
        this.onHRMBatteryChange = this.onHRMBatteryChange.bind(this);

        this.#timerID = setInterval(this.onTimerTick, 1000);
        this.#started = false;
    }

    connectedCallback() {
        this.shadowRoot.querySelector('#connect').addEventListener('click', this.doScan);
        this.shadowRoot.querySelector('#startstop').addEventListener('click', this.doStartStop);
        this.shadowRoot.querySelector('#pauseunpause').addEventListener('click', this.doPauseUnpause);
        this.shadowRoot.querySelector('#fullscreen').addEventListener('click', this.doFullScreen);
        document.addEventListener("fullscreenchange", this.onFullScreenChanged);
        const locationOptions = { enableHighAccuracy: true };
        navigator.geolocation.watchPosition(this.onPositionChanged, undefined, locationOptions);
    }

    disconnectedCallback() {
    }

    async doScan() {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['heart_rate']}],
            optionalServices: ['battery_service']
        });

        if (device) {
            const server = await device.gatt.connect();

            const service = await server.getPrimaryService('heart_rate');
            const characteristic = await service.getCharacteristic('heart_rate_measurement');
            if (characteristic.properties.notify) {
                characteristic.addEventListener( "characteristicvaluechanged", this.onHRMNotify);
                await characteristic.startNotifications();
            }

            try {
                const service = await server.getPrimaryService('battery_service');
                const characteristic = await service.getCharacteristic('battery_level');

                const battery = (await characteristic.readValue()).getUint8(0);
                this.setHRMBat(battery + '%');

                characteristic.addEventListener('characteristicvaluechanged', this.HRMonBatteryChange);
                await characteristic.startNotifications();
            } catch(err) {
                console.log("Error with battery service: ", err);
            }

        }
    }

    doStartStop() {
        this.#started = !this.#started;
        if (this.#started) {
            this.shadowRoot.querySelector('#startstop').textContent = 'stop';

            this.#startDate = new Date();

            this.shadowRoot.querySelector('#pauseunpause').disabled = false;
            this.#activeTime = 0;
            this.activate();
        } else {
            this.shadowRoot.querySelector('#startstop').textContent = 'start';

            this.shadowRoot.querySelector('#pauseunpause').disabled = true;
            this.deactivate();
        }
    }

    doPauseUnpause() {
        this.#active = !this.#active;
        if (this.#active) {
            this.activate(new Date());
        } else {
            this.deactivate();
        }
    }

    activate() {
        this.#active = true;
        this.#activeDate = new Date();

            this.shadowRoot.querySelector('#pauseunpause').textContent = 'pause';
    }

    deactivate() {
        this.#active = false;
        this.#activeTime += new Date() - this.#activeDate;

        this.shadowRoot.querySelector('#pauseunpause').textContent = 'play_arrow';
    }

    doFullScreen() {
        let elem = document.querySelector("html");

        if (!document.fullscreenElement) {
            this.shadowRoot.querySelector('#fullscreen').textContent = 'fullscreen_exit';

            elem.requestFullscreen();
        } else {
            this.shadowRoot.querySelector('#fullscreen').textContent = 'fullscreen';

            document.exitFullscreen();
        }
    }

    onFullScreenChanged() {
        if (!document.fullscreenElement) {
            this.shadowRoot.querySelector('#fullscreen').textContent = 'fullscreen';
        } else {
            this.shadowRoot.querySelector('#fullscreen').textContent = 'fullscreen_exit';
        }
    }

    setActive(str) {
        this.shadowRoot.querySelector('#active').textContent = str;
    }

    setElapsed(str) {
        this.shadowRoot.querySelector('#elapsed').textContent = str;
    }

    timeDiffToString(time) {
        const seconds = time.getUTCSeconds();
        const minutes = time.getUTCMinutes();
        const hours = time.getUTCHours();

        if (hours > 0) {
            return hours.toString() + ":" + minutes.toString().padStart(2, "0") + ":" + seconds.toString().padStart(2, "0");
        } else if (minutes > 0) {
            return minutes.toString() + ":" + seconds.toString().padStart(2, "0");
        } else {
            return seconds;
        }
    }

    setTime(str) {
        this.shadowRoot.querySelector('#time').textContent = str;
    }

    timeToString(time) {
        const seconds = time.getSeconds();
        const minutes = time.getMinutes();
        const hours = time.getHours();

        return hours.toString() + ":" + minutes.toString().padStart(2, "0") + ":" + seconds.toString().padStart(2, "0");
    }

    onTimerTick() {
        const now = Date.now();

        if (this.#active) {
            const diff = now - this.#activeDate;

            this.setActive(this.timeDiffToString(new Date(this.#activeTime + diff)));
        }

        if (this.#started) {
            const diff = now - this.#startDate;

            this.setElapsed(this.timeDiffToString(new Date(diff)));
        }

        this.setTime(this.timeToString(new Date(now)));
    }

    onPositionChanged(position) {
        this.shadowRoot.querySelector('#position').textContent = position.coords.latitude + "/" + position.coords.longitude;
    }

    setHR(str) {
        this.shadowRoot.querySelector('#hr').textContent = str;
    }
    setHRMBat(str) {
        this.shadowRoot.querySelector('#hrm_bat').textContent = str;
    }

    onHRMNotify(event) {
        console.log(`Received heart rate measurement: ${event.target.value.getUint8(0)} ${event.target.value.getUint8(1)}`);

        const hr = event.target.value.getUint8(1);

        this.setHR(hr);
    }

    onHRMBatteryChange(event) {
        console.log(`Battery change event: ${event.target.value.getUint8(0)}`);

        const battery = event.target.value.getUint8(0);

        this.setHRMBat(battery + '%');
    }
}

customElements.define('main-app', MainApp);
  </script>
</html>
