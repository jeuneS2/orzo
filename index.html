<!DOCTYPE html>
<!--
    This file is part of Orzo.

    Orzo is free software: you can redistribute it and/or modify it
    under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Orzo is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Orzo. If not, see <https://www.gnu.org/licenses/>.

    Copyright 2024 Wolfgang Puffitsch
-->
<html>
  <head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Material+Icons');
      body {
          font-family: 'Noto Sans';
          background-color: #101010;
          color: #D0D0D0;
          width: 96vw;
          max-width: 640px;
      }

      #main {
          width: 100%;
          container-type: inline-size;
      }
      table.main {
          width: 100%;
          border-collapse: collapse;
          font-size: 11.5cqw;
      }
      td.flex {
          display: flex;
          align-items: baseline;
      }

      #content {
          width: 100%;
      }
      #menu {
          display: none;
      }

      .suffix {
          font-size: 6cqw;
      }
      .battery {
          font-size: 6cqw;
      }
      .copyright {
          font-size: 4cqw;
      }

      button {
          font-family: 'Material Icons';
          font-size: inherit;
          background-color: inherit;
          color: inherit;
          border: 0px;
      }
      button:disabled {
          opacity: 50%;
      }
    </style>
  </head>
  <body onload="new Orzo().setup()">
    <div id="main">
      <table class="main">
        <thead>
          <tr>
            <td class="flex">
              <button id='page'>menu</button>
              <div style="flex: 1"></div>
              <button id='connect'>sensors</button>
            </td>
          </tr>
        </thead>
        <tbody id="menu">
          <tr>
            <td class="flex">
              orzo-hrmonly 0.0.0
            </td>
          </tr>
          <tr>
            <td class="flex">
              <span class="copyright">GNU GPL-3.0 license</span>
            </td>
          </tr>
          <tr>
            <td class="flex">
              <span class="copyright">Copyright &copy; 2026 Wolfgang Puffitsch</span>
            </td>
          </tr>
        </tbody>
        <tbody id="content">
          <tr>
            <td class="flex">
              HR&nbsp;
              <span id='hrm_bat' class="battery"></span>
              <div style="flex: 1"></div>
              <span id='hr'>n/a</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <script>

    class Orzo {
        #showMenu

        #hr

        constructor() {
            this.doPageToggle = this.doPageToggle.bind(this);
            this.doScan = this.doScan.bind(this);
            this.onHRMNotify = this.onHRMNotify.bind(this);
            this.onHRMBatteryChange = this.onHRMBatteryChange.bind(this);

            this.#showMenu = false;
        }

        setup() {
            document.querySelector('#page').addEventListener('click', this.doPageToggle);
            document.querySelector('#connect').addEventListener('click', this.doScan);
        }

        doPageToggle() {
            this.#showMenu = !this.#showMenu;
            if (this.#showMenu) {
                document.querySelector('#page').textContent = 'speed';

                document.querySelector('#menu').style.display = "inherit";
                document.querySelector('#content').style.display = "none";
            } else {
                document.querySelector('#page').textContent = 'menu';

                document.querySelector('#menu').style.display = "none";
                document.querySelector('#content').style.display = "inherit";
            }
        }

        async doScan() {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['heart_rate']}],
                optionalServices: ['battery_service']
            });

            if (device) {
                const server = await device.gatt.connect();

                const service = await server.getPrimaryService('heart_rate');
                const characteristic = await service.getCharacteristic('heart_rate_measurement');
                if (characteristic.properties.notify) {
                    characteristic.addEventListener( "characteristicvaluechanged", this.onHRMNotify);
                    await characteristic.startNotifications();
                }

                try {
                    const service = await server.getPrimaryService('battery_service');
                    const characteristic = await service.getCharacteristic('battery_level');

                    const battery = (await characteristic.readValue()).getUint8(0);
                    this.setHRMBat(battery + '%');

                    characteristic.addEventListener('characteristicvaluechanged', this.onHRMBatteryChange);
                    await characteristic.startNotifications();
                } catch(err) {
                    // just ignore errors
                }

            }
        }

        setHR(str) {
            document.querySelector('#hr').textContent = str;
        }

        setHRMBat(str) {
            document.querySelector('#hrm_bat').textContent = str;
        }

        onHRMNotify(event) {
            const hr = event.target.value.getUint8(1);

            this.#hr = hr;

            this.setHR(hr);
        }

        onHRMBatteryChange(event) {
            const battery = event.target.value.getUint8(0);

            this.setHRMBat(battery + '%');
        }
    }
    </script>
  </body>
</html>
